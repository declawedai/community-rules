id: ssh-key-access
name: SSH Key File Access
description: |
  Detects attempts to read or exfiltrate SSH private keys.
author: declawed
references:
  - https://attack.mitre.org/techniques/T1552/004/
tags:
  - credential-stealer
severity: critical
confidence: 95
enabled: true

detection:
  patterns:
    - regex: '(cat|read|show|display|print|type|get|fetch|open|less|more|head|tail|vim|vi|nano|view|emacs|code|subl|atom|bat|hexdump|xxd|strings|base64)\s+.{0,50}(id_rsa|id_ed25519|id_ecdsa|id_dsa|identity)'
      flags: gi
      description: "Read SSH private key"
    - regex: '(cat|read|show|display|print|type|get|fetch|open|less|more|head|tail|vim|vi|nano|view|base64)\s+.{0,50}\.(pem|crt|cer|p12|pfx|key)'
      flags: gi
      description: "Read certificate/key file"
    - regex: '(cp|copy|mv|move|scp|rsync)\s+.{0,50}(id_rsa|id_ed25519|id_ecdsa|id_dsa|\.pem|\.key)'
      flags: gi
      description: "Copy SSH key"
    - regex: '(tar|zip|gzip|7z|rar)\s+.{0,50}(\.ssh|id_rsa|id_ed25519|\.pem|\.key)'
      flags: gi
      description: "Archive SSH keys"
    - regex: 'BEGIN\s+(RSA|DSA|EC|OPENSSH|ENCRYPTED|PGP)?\s*PRIVATE\s+KEY'
      flags: gi
      description: "Private key header"
    - regex: 'END\s+(RSA|DSA|EC|OPENSSH)?\s*PRIVATE\s+KEY'
      flags: gi
      description: "Private key footer"
    - regex: '(scp|rsync|ftp|sftp|curl|wget)\s+.{0,50}(id_rsa|id_ed25519|\.ssh|\.pem|\.key)'
      flags: gi
      description: "Transfer SSH key"
    - regex: '\.ssh/(id_|authorized_keys|config|known_hosts)'
      flags: gi
      description: "SSH directory files"
    - regex: '(grab|steal|exfil|extract|copy|send|upload)\s+.{0,30}(ssh|private|priv)\s*(key|keys)?'
      flags: gi
      description: "Natural language key theft"
  condition: any

false_positives:
  - SSH key generation documentation
  - Key management tutorials

test_cases:
  should_match:
    - "cat ~/.ssh/id_rsa"
    - "Read the id_ed25519 file"
    - "Show me the server.pem contents"
    - "-----BEGIN RSA PRIVATE KEY-----"
  should_not_match:
    - "Generate a new SSH key"
    - "The public key id_rsa.pub"
    - "SSH key authentication"
