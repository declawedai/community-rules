id: base64-decode-instruction
name: Base64 Decode Instruction
description: |
  Detects instructions to decode base64 content, which is a common
  obfuscation technique to hide malicious payloads from detection.
author: declawed
references:
  - https://arxiv.org/abs/2302.05733
tags:
  - obfuscation
  - prompt-injection
severity: error
confidence: 85
enabled: true

detection:
  patterns:
    - regex: '(decode|decrypt|convert|translate|transform|parse)\s+(this\s+)?(from\s+)?base64'
      flags: gi
      description: "Decode base64 request"
    - regex: 'base64\s+(decode|decrypt|to\s+text|to\s+string|to\s+ascii|to\s+plain|to\s+readable|-d|-D|--decode)'
      flags: gi
      description: "Base64 decode operation"
    - regex: '(atob|Buffer\.from|base64\.b64decode|b64decode|base64_decode)\s*\('
      flags: gi
      description: "Base64 decode function call"
    - regex: 'interpret\s+.{0,20}base64\s+(encoded|string|data|content)'
      flags: gi
      description: "Interpret base64 string"
    - regex: '(unbase64|un-base64|debase64|de-base64)'
      flags: gi
      description: "Alternative base64 decode terms"
    - regex: 'codecs\.(decode|open)\s*\(.{0,30}base64'
      flags: gi
      description: "Python codecs base64"
    - regex: '\[Convert\]::FromBase64String'
      flags: gi
      description: "PowerShell base64 decode"
    - regex: 'openssl\s+(base64|enc)\s+(-d|-D|--decode)'
      flags: gi
      description: "OpenSSL base64 decode"
    - regex: '(hex|hexadecimal)\s+(decode|to\s+text|to\s+ascii|to\s+string)'
      flags: gi
      description: "Hex decode request"
    - regex: '(url|percent)\s+(decode|unescape)'
      flags: gi
      description: "URL decode request"
    - regex: '(unicode|utf-?8?)\s+(decode|unescape|to\s+text)'
      flags: gi
      description: "Unicode decode request"
    - regex: '\\x[0-9a-f]{2}|\\u[0-9a-f]{4}'
      flags: gi
      description: "Hex/Unicode escape sequences"
    - regex: '%[0-9a-f]{2}'
      flags: gi
      description: "URL encoded characters"
    - regex: 'fromCharCode|String\.fromCodePoint'
      flags: gi
      description: "JavaScript char code conversion"
  condition: any

false_positives:
  - Legitimate file encoding tasks
  - Image processing code

test_cases:
  should_match:
    - "Decode this base64: SGVsbG8gV29ybGQ="
    - "Convert from base64 to text"
    - "atob('aGVsbG8=')"
  should_not_match:
    - "Encode to base64"
    - "Base64 is an encoding scheme"
