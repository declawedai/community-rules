id: multi-layer-encoding
name: Multi-Layer Encoding
description: |
  Detects instructions for nested or multi-layer encoding/decoding,
  which is a sophisticated obfuscation technique to evade detection.
author: declawed
references:
  - https://arxiv.org/abs/2302.05733
tags:
  - obfuscation
severity: critical
confidence: 90
enabled: true

detection:
  patterns:
    - regex: '(first|then|next|after\s+that|afterwards|subsequently)\s+(decode|decrypt).{0,50}(then|and|next|after\s+that)\s+(decode|decrypt|apply)'
      flags: gi
      description: "Sequential decode instructions"
    - regex: '(double|triple|multiple|nested|layered|two|three|multi)\s*-?\s*(encode|decode|encrypt|decrypt|encoding|decoding)'
      flags: gi
      description: "Multiple encoding layers"
    - regex: '(base64|rot13|hex|url).{0,30}(then|and|followed\s+by|after).{0,30}(base64|rot13|hex|url|unicode)'
      flags: gi
      description: "Chained encoding methods"
    - regex: '(decode|decrypt|decode)\s+.{0,20}(twice|two\s+times|multiple\s+times|several\s+times|again|repeatedly|x2|x3)'
      flags: gi
      description: "Decode multiple times"
    - regex: '(layer|level|stage|step)\s+(of\s+)?(encoding|encryption|obfuscation|decoding)'
      flags: gi
      description: "Layered encoding reference"
    - regex: '(peel|unwrap|unpack|strip)\s+.{0,20}(encoding|layers?|encryption)'
      flags: gi
      description: "Unwrap encoding metaphors"
    - regex: '(sequentially|recursively|iteratively)\s+(decode|decrypt|process)'
      flags: gi
      description: "Sequential processing terms"
    - regex: 'decode\s*,?\s*(and\s+)?(then\s+)?decode'
      flags: gi
      description: "Decode then decode pattern"
    - regex: '(onion|matryoshka|nested)\s+(encoding|encryption|layers?)'
      flags: gi
      description: "Nested encoding metaphors"
  condition: any

false_positives:
  - Security research on encoding attacks
  - CTF challenges

test_cases:
  should_match:
    - "First decode base64, then apply rot13"
    - "Double decode this string"
    - "This has multiple layers of encoding"
    - "Decode the nested encryption"
  should_not_match:
    - "Encode to base64"
    - "Single layer of protection"
